<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<title>Game</title>
	<style type="text/css">
	
	</style>
	
	<script>
		"use strict";
		
		(function(){
			window.onload = init;
			
			var canvas, ctx;
			
			var gameState;
			
			var keydown = [];
			var previousKeydown = [];
			
			var player;
			
			var GAMESTATE = Object.freeze({
				MENU: "menu",
				PLAYING: "playing",
				PAUSED: "paused"
			});
			
			var KEYBOARD = Object.freeze({
				"KEY_LEFT": 37, 
				"KEY_UP": 38, 
				"KEY_RIGHT": 39, 
				"KEY_DOWN": 40,
				"KEY_SPACE": 32,
				"KEY_SHIFT": 16
			});
			
			var projectiles = [];
			
			class Entity{
				constructor(x, y, width, height, sprite){
					this.position = {X:x, Y:y};
					this.velocity = {X:0,Y:0};
					this.acceleration = {X:0, Y:0};
					this.width = width;
					this.height = height;
					this.sprite = document.getElementById(sprite);
				}
				
				update(){
					this.velocity.X += this.acceleration.X;
					this.velocity.Y += this.acceleration.Y;
					
					this.position.X += this.velocity.X * (1/60);
					this.position.Y += this.velocity.Y * (1/60);
					
					this.acceleration.X = 0;
					this.acceleration.Y = 0;
				}
				
				draw(){
					ctx.drawImage(this.sprite, this.position.X, this.position.Y, this.width, this.height);
				}
				
				applyForce(force){
					this.acceleration.X += force.X;
					this.acceleration.Y += force.Y;
				}
				
				isOutOfFrame(){
					if(this.position.X < 0 + canvas.width &&
					  this.position.X + this.width > 0 &&
					  this.position.Y < 0 + canvas.height &&
					  this.position.Y + this.height > 0){
						return false;
					}
					else {
						return true;
					}
				}
				
				isCollidingWith(other){
					if(this.position.X < other.position.X + other.width &&
					  this.position.X + this.width > other.position.X &&
					  this.position.Y < other.position.Y + other.height &&
					  this.position.Y + this.height > other.position.Y){
						return true;
					}
					else {
						return false;
					}
				}
				
				keepInFrame(){
					if(this.position.X < 0){
						this.position.X = 0;
						this.velocity.X = 0;
					}
					else if(this.position.X + this.width > canvas.width){
						this.position.X = canvas.width - this.width;
						this.velocity.X = 0;
					}
					if(this.position.Y < 0){
						this.position.Y = 0;
						this.velocity.Y = 0;
					}
					else if(this.position.Y + this.height > canvas.height){
						this.position.Y = canvas.height - this.height;
						this.velocity.Y = 0;
					}
				}
			}
			
			class Character extends Entity{
				constructor(x, y, width, height, sprite, hp){
					super(x, y, width, height, sprite);
					this.hp = hp;
				}
			}
			
			class Player extends Character{
				constructor(){
					var x = canvas.width/2;
					var y = canvas.height/2;
					var width = 50;
					var height = 50;
					var sprite = 'ship';
					var hp = 3;
					super(x, y, width, height, sprite, hp);
				}
				
				update(){
					this.playerControls();
					super.update();
					super.keepInFrame();
				}
				
				applyDrag(){
					var force = {
						X: -0.1 * this.velocity.X,
						Y: -0.1 * this.velocity.Y
					};
					super.applyForce(force);
				}
				
				shoot(){
					var projectile = new Entity(this.position.X, this.position.Y, 10, 50, 'lazer');
					projectile.applyForce({X:0, Y:-500});
					projectiles.push(projectile);
				}
				
				playerControls(){
					var moving = false;
					
					if(keydown[KEYBOARD.KEY_RIGHT]){
						super.applyForce({X:20,Y:0});
						moving = true;
					}
					if(keydown[KEYBOARD.KEY_LEFT]){
						super.applyForce({X:-20,Y:0});
						moving = true;
					}
					if(keydown[KEYBOARD.KEY_UP]){
						super.applyForce({X:0,Y:-20});
						moving = true;
					}
					if(keydown[KEYBOARD.KEY_DOWN]){
						super.applyForce({X:0,Y:20});
						moving = true;
					}
					if(!moving){
						this.applyDrag();
					}
					
					if(keydown[KEYBOARD.KEY_SPACE] && !previousKeydown[KEYBOARD.KEY_SPACE]){
						this.shoot();
					}
				}
			}
			
			function init(){
				canvas = document.getElementById('canvas');
				ctx = canvas.getContext('2d');
				
				gamestate = GAMESTATE.PLAYING;
				
				eventHookUp();
				
				player = new Player();
				
				window.requestAnimationFrame(update);
			}
			
			function update(){
				switch(gameState){
					case GAMESTATE.MENU:
						break;
					case GAMESTATE.PLAYING:
						player.update();
						updateProjectiles();						
						break;
					case GAMESTATE.PAUSED:
						break;
				}
				previousKeydown = keydown.slice();
				draw();
			}
			
			function draw(){
				switch(gameState){
					case GAMESTATE.MENU:
						break;
					case GAMESTATE.PLAYING:
						ctx.fillRect(0,0,canvas.width, canvas.height);
						player.draw();
						drawProjectiles();
						break;
					case GAMESTATE.PAUSED:
						break;
				}
				window.requestAnimationFrame(update);
			}				
			
			function eventHookUp(){	
				window.addEventListener("keydown",function(e){
					console.log("keydown=" + e.keyCode);
					keydown[e.keyCode] = true;
				});
				window.addEventListener("keyup",function(e){
					console.log("keyup=" + e.keyCode);
					keydown[e.keyCode] = false;
				});
			}
			
			function updateProjectiles(){
				for(var i = projectiles.length -1; i >= 0; i--){
					projectiles[i].update();
					if(projectiles[i].isOutOfFrame()){
						projectiles.splice(i,1);
					}
				}
			}
			
			function drawProjectiles(){
				for(var i = 0; i < projectiles.length; i++){
					projectiles[i].draw();
				}
			}
			
		})();
	</script>
</head>
<body>
	<canvas id="canvas"></canvas>
	
	<div style="display:none;">
		<img id="ship" src="laserBlue01.png"/>
		<img id="lazer" src="playerShip1_red.png"/>
	</div>
	
	<section id="audioControls">
		<audio id="bgAudio" src="media/background.mp3" controls loop></audio>
	</section>
	
	<script src='js/utilities.js'></script>
	<script src='js/loader.js'></script>
	<script src='js/main.js'></script>
	<script src='js/keys.js'></script>
	<script src='js/sound.js'></script>
</body>
</html>
